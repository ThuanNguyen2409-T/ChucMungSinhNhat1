<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ch√∫c m·ª´ng sinh nh·∫≠t (Particles)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    html,body{ margin:0; height:100%; background:#380738; overflow:hidden; }
    canvas{ display:block; width:100vw; height:100vh; background:#380738; }
    /* th√™m font Poppins t·ª´ Google Fonts */
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

<script>
// canvas ch√≠nh
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
//canvas ·∫©n (canvas test)
const offCanvas = document.createElement('canvas');
const offCtx = offCanvas.getContext('2d');
//m√†n h√¨nh t·ªâ l·ªá cao
let DPR = window.devicePixelRatio || 1;
//c·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc canvas
function resizeAll(){
  DPR = window.devicePixelRatio || 1;
  canvas.width = Math.floor(window.innerWidth * DPR);
  canvas.height = Math.floor(window.innerHeight * DPR);
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  offCanvas.width = canvas.width;
  offCanvas.height = canvas.height;

  // scale theo DPR
  ctx.setTransform(DPR,0,0,DPR,0,0);
  offCtx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resizeAll);
window.addEventListener('orientationchange', resizeAll);
resizeAll();

// m·∫£ng h·∫°t
let particles = [];
const gap = 6; // kho·∫£ng c√°ch c·ªßa c√°c h·∫°t(c√†ng nh·ªè c√†ng lag)
const baseR = 2; // k√≠ch th∆∞·ªõc h·∫°t
//l·ªõp h·∫°t
class Particle {
  constructor(x= Math.random()*canvas.width/DPR, y= Math.random()*canvas.height/DPR){
    this.x = x;
    this.y = y;
    this.tx = x;
    this.ty = y;
    this.r = baseR;
    this.hue = Math.random()*360;
    // v·ªã tr√≠ ban ƒë·∫ßu ƒë·ªÉ di chuy·ªÉn ng·∫´u nhi√™n
    this.vx = (Math.random()-0.5)*2;
    this.vy = (Math.random()-0.5)*2;
  }
  update(dt){
    // dao ƒë·ªông ƒëi·ªÅu h√≤a theo c√¥ng th·ª©c x = x0 + A*sin(wt + phi)
    const ease = 0.08;
    this.x += (this.tx - this.x)*ease + 0.2*Math.sin(Date.now()*0.002 + this.x);
    this.y += (this.ty - this.y)*ease + 0.2*Math.cos(Date.now()*0.002 + this.y);
    this.hue = (this.hue + 1.2) % 360;
  }
  draw(){
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.r, 0, Math.PI*2);
    ctx.fillStyle = `hsl(${this.hue},90%,60%)`;
    // small glow
    ctx.shadowColor = 'rgba(255,255,255,0.25)';
    ctx.shadowBlur = 6;
    ctx.fill();
    ctx.shadowBlur = 0;
  }
}

// h√†m l·∫•y t·ªça ƒë·ªô c√°c ƒëi·ªÉm t·ª´ text
function getTargetsFromText(text){
  // v·∫Ω text l√™n offCanvas 
  const maxSide = Math.min(window.innerWidth, window.innerHeight);
  // font size ∆∞·ªõc l∆∞·ª£ng theo ƒë·ªô d√†i text
  const approxLen = Math.max(6, text.length);
  const fontSize = Math.floor(maxSide / Math.max(4, approxLen/3));
  offCtx.clearRect(0,0, offCanvas.width, offCanvas.height);
  offCtx.fillStyle = '#ffffff';
  offCtx.textAlign = 'center';
  offCtx.textBaseline = 'middle';
  offCtx.font = `${fontSize}px Poppins`;

  // xu·ªëng d√≤ng n·∫øu c√≥ '\n'
  const lines = text.split('\n');
  const lh = fontSize * 1.15;
  const startY = (offCanvas.height / DPR) / 2 - ( (lines.length-1) * lh / 2 );
  for(let i=0;i<lines.length;i++){
    offCtx.fillText(lines[i], (offCanvas.width/DPR)/2, startY + i*lh);
  }

  // l·∫•y d·ªØ li·ªáu h√¨nh ·∫£nh tr√™n offCanvas
  const img = offCtx.getImageData(0,0, offCanvas.width, offCanvas.height).data;
  const targets = [];
  const w = offCanvas.width / DPR;
  const h = offCanvas.height / DPR;
  for(let y = 0; y < h; y += gap){
    for(let x = 0; x < w; x += gap){
      const xi = Math.floor(x*DPR);
      const yi = Math.floor(y*DPR);
      const idx = (yi * (offCanvas.width) + xi) * 4;
      if(img[idx+3] > 128){
        targets.push({ x: x, y: y });
      }
    }
  }
  return targets;
}

// h√†m √°p d·ª•ng t·ªça ƒë·ªô m·ª•c ti√™u cho c√°c h·∫°t
function applyTargets(targets){
  // th√™m h·∫°t n·∫øu ch∆∞a ƒë·ªß
  if(particles.length < targets.length){
    const need = targets.length - particles.length;
    for(let i=0;i<need;i++){
      // sinh h·∫°t m·ªõi ·ªü v·ªã tr√≠ ng·∫´u nhi√™n
      particles.push(new Particle(Math.random()*canvas.width/DPR, Math.random()*canvas.height/DPR));
    }
  }
  // c·∫≠p nh·∫≠t t·ªça ƒë·ªô m·ª•c ti√™u cho c√°c h·∫°t
  for(let i=0;i<particles.length;i++){
    if(i < targets.length){
      particles[i].tx = targets[i].x;
      particles[i].ty = targets[i].y;
      particles[i].r = baseR;
    } else {
      // di chuy·ªÉn h·∫°t th·ª´a ra ngo√†i m√†n h√¨nh
      particles[i].tx = Math.random()*canvas.width/DPR;
      particles[i].ty = Math.random()*canvas.height/DPR;
      particles[i].r = baseR * 0.9;
    }
  }
}

// h√†m ch√≠nh ƒë·ªÉ v·∫Ω text d∆∞·ªõi d·∫°ng h·∫°t
function drawTextParticles(text){
  const targets = getTargetsFromText(text);
  applyTargets(targets);
}

//l·∫∑p l·∫°i h√†m animate
let last = performance.now();
function animate(now){
  const dt = now - last;
  last = now;
  // x√≥a background
  ctx.fillStyle = '#380738';
  ctx.fillRect(0,0, canvas.width/DPR, canvas.height/DPR);

  for(let p of particles){
    p.update(dt);
    p.draw();
  }
  requestAnimationFrame(animate);
}

//b·ªô ƒë·∫øm ng∆∞·ª£c v√† c√¢u ch√∫c
const sequence = [
  { text: '3', duration: 1000 },
  { text: '2', duration: 1000 },
  { text: '1', duration: 1000 },
  { text: 'Ch√∫c b√† c√≥ 1\nsinh nh·∫≠t th·∫≠t vui v·∫ª nha üéâ', duration: 3500 }
];

function runSequence(seq){
  let i = 0;
  function next(){
    if(i >= seq.length) return;
    drawTextParticles(seq[i].text);
    setTimeout(()=>{
      i++;
      next();
    }, seq[i].duration);
  }
  next();
}

// kh·ªüi ƒë·ªông ho·∫°t ·∫£nh
requestAnimationFrame(animate);
window.addEventListener('load', ()=> {
  // v·∫Ω s·ªë "3" ban ƒë·∫ßu
  drawTextParticles('3');
  // cho delay tr∆∞·ªõc khi ch·∫°y chu·ªói
  setTimeout(()=> runSequence(sequence), 350);
});
// x·ª≠ l√Ω khi thay ƒë·ªïi k√≠ch th∆∞·ªõc c·ª≠a s·ªï
window.addEventListener('resize', ()=>{
  resizeAll();
});
</script>
</body>
</html>
